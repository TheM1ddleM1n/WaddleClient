name: Bump Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 5.1)'
        required: true
        type: string

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version input
        id: version
        run: |
          VERSION=${{ github.event.inputs.version }}
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Invalid version format. Use: 5.1 or 5.1.0"
            exit 1
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update version in all files
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          
          # Update WaddleClient.js @version
          sed -i "s/@version[[:space:]]*[0-9.]*/@version      ${VERSION}/" WaddleClient.js
          
          # Update WaddleClient.js const SCRIPT_VERSION
          sed -i "s/const SCRIPT_VERSION = '[0-9.]*'/const SCRIPT_VERSION = '${VERSION}'/" WaddleClient.js
          
          # Update README.md badge
          sed -i "s/badge\/version-[0-9.]*-/badge\/version-${VERSION}-/" README.md

      - name: Verify version consistency
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          SCRIPT_VERSION=$(grep -oP "@version\s+\K[0-9.]+" WaddleClient.js)
          CONST_VERSION=$(grep -oP "const SCRIPT_VERSION = '\K[0-9.]+(?=')" WaddleClient.js)
          README_VERSION=$(grep -oP "badge/version-\K[0-9.]+" README.md)
          
          echo "Script @version: $SCRIPT_VERSION"
          echo "Script const: $CONST_VERSION"
          echo "README version: $README_VERSION"
          echo "Input version: $VERSION"
          
          if [ "$SCRIPT_VERSION" != "$VERSION" ] || [ "$CONST_VERSION" != "$VERSION" ] || [ "$README_VERSION" != "$VERSION" ]; then
            echo "Version mismatch!"
            exit 1
          fi

      - name: Commit version bump
        run: |
          git config user.name "üêßBot"
          git config user.email "bot@waddleclient.dev"
          git add WaddleClient.js README.md
          git commit -m "chore: bump version to v${{ steps.version.outputs.VERSION }}" || true
          git push
